{
  "variables": {
    "access_key": "{access_key}",
    "secret_key": "{secret_key}"
                },
  "builders": [{
    "type": "amazon-ebs",
    "access_key": "{{user `access_key`}}",
    "secret_key": "{{user `secret_key`}}",
    "region": "{region}",
    "source_ami": "(base_ami)",
    "instance_type": "t2.micro",
    "ssh_username": "admin",
    "ami_name": "packer-cg-kops-{{timestamp}}"
              }],
  "provisioners": [{
    "type": "shell",
    "inline": [
      "sleep 30",
      "sudo apt-get update",
      "sudo apt-get install -y openssh-server ethtool build-essential libpcap-dev libpcre3-dev libdumbnet-dev bison flex zlib1g-dev liblzma-dev openssl libssl-dev libcurl4-openssl-dev zlib1g-dev libpng-dev libxml2-dev libjson-c-dev libbz2-dev libpcre3-dev ncurses-dev",
      "wget https://www.snort.org/downloads/snort/daq-2.0.6.tar.gz",
      "wget https://www.snort.org/downloads/archive/snort/snort-2.9.8.2.tar.gz",
      "tar xvzf daq-2.0.6.tar.gz",
      "cd daq-2.0.6",
      "./configure && make && sudo make install",
      "cd ..",
      "tar xvzf snort-2.9.8.2.tar.gz",
      "cd snort-2.9.8.2",
      "./configure --enable-sourcefire && make && sudo make install",
      "sudo mkdir /etc/snort",
      "sudo mkdir /etc/snort/preproc_rules",
      "sudo mkdir /etc/snort/rules",
      "sudo mkdir /var/log/snort",
      "sudo mkdir /usr/local/lib/snort_dynamicrules",
      "sudo touch /etc/snort/rules/white_list.rules",
      "sudo touch /etc/snort/rules/black_list.rules",
      "sudo touch /etc/snort/rules/local.rules",
      "sudo chmod -R 5775 /etc/snort/ ",
      "sudo chmod -R 5775 /var/log/snort/ ",
      "sudo chmod -R 5775 /usr/local/lib/snort",
      "sudo chmod -R 5775 /usr/local/lib/snort_dynamicrules/",
      "sudo cp -avr etc/*.conf etc/*.map etc/*.dtd /etc/snort/",
      "sudo cp -avr src/dynamic-preprocessors/build/usr/local/lib/snort_dynamicpreprocessor/* /usr/local/lib/snort_dynamicpreprocessor/",
      "cd ~/",
      "wget https://www.clamav.net/downloads/production/clamav-0.102.2.tar.gz",
      "tar xzf clamav-0.102.2.tar.gz",
      "cd clamav-0.102.2",
      "./configure --prefix=/usr/local/clamav --disable-clamav --sysconfdir=/etc",
      "make && sudo make install",
      "sudo cp /home/admin/clamav-0.102.2/etc/freshclam.conf.sample /etc/freshclam.conf",
      "sudo mkdir /usr/local/clamav/database",
      "sudo chmod -R 777 /usr/local/clamav/database/",
      "TMPCONF=$(mktemp)",
      "cat << EOF > $TMPCONF",
      "DatabaseDirectory /usr/local/clamav/database",
      "DatabaseMirror db.us.clamav.net",
      "DatabaseMirror database.clamav.net",
      "EOF",
      "/usr/local/clamav/bin/freshclam -u root --config-file $TMPCONF",
      "rm $TMPCONF"
            ]
            }]
}
